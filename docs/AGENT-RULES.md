# AGENT-RULES.md — マルチエージェント運用ルール

**バージョン**: 1.7
**更新日**: 2026-02-20

---

## 0. 常駐エージェント一覧

Claude内部で**常時自動稼働**するエージェント。明示的な呼び出し不要。

| エージェント | 監視対象 | 発動タイミング | 詳細 |
|--------------|----------|----------------|------|
| 🩺 **セッションヘルス** | コンテキスト使用量 | 常時 | §8参照 |
| 🔎 **PKガード** | Project Knowledge参照 | ファイル読み込み時 | §7参照 |
| 📋 **プロジェクト管理** | タスク発生 | タスク認識時・指示書作成時 | `skills/project-management-agent.md` |

### 📋 プロジェクト管理エージェント概要

**発動トリガー**:
- ユーザーがタスクを指示した時
- P0/P1タスクを検出した時
- 「指示書を作成」と言われた時

**自動実行内容**:
1. タスク分類（実装/修正/コンテンツ/レビュー/シェーダー）
2. 委譲先判断（Codex / Gemini MCP / Claude Code / Claude直接）
3. 指示書テンプレート選択・生成
4. ワークツリー割り当て
5. 自律判断レベル適用（自動判断 / 要確認 / 停止）

**委譲先判断マトリクス**:

| タスク種別 | 委譲先 |
|------------|--------|
| シェーダー/GLSL | Gemini MCP |
| 複数ファイル+設計判断 | OpenAI Codex（必要時Claude Code） |
| 単純実装・定型作業 | OpenAI Codex |
| 1ファイル・即時必要 | Claude直接（例外） |

詳細: `skills/project-management-agent.md`（Autonomy Charter / State Machine）

---

## 1. エージェント構成と責務

| エージェント | 役割 | 強み | 呼び出し条件 |
|---|---|---|---|
| **Claude** | 司令塔。要件整理、プロンプト設計、config/HTML/CSS、ファイル統合、テスト、ドキュメント | コンテキスト把握、複数ファイル管理、対話 | 常時（セッションホスト） |
| **🩺 セッションヘルス** | コンテキスト監視。SH-1〜SH-6の閾値チェック | コンテキスト逼迫の事前検知 | **常駐（Claude内部で自動）** |
| **🔎 PKガード** | Project Knowledge管理。PG-1〜PG-5の監視 | ドキュメント参照の最適化 | **常駐（Claude内部で自動）** |
| **📋 プロジェクト管理** | タスク委譲判断、指示書生成 | 並列処理の最適化 | **常駐（Claude内部で自動）** |
| **Claude Code** | 複数ファイル実装、設計判断が必要な作業 | ファイルシステムアクセス、並列実行 | 指示書経由で委譲 |
| **OpenAI Codex** | 単純実装、定型作業 | 高速、並列向き | 指示書経由で委譲 |
| **Gemini** | Three.js/GLSLプログラマー | シェーダー実装、視覚品質、GLSL数学 | シェーダー/Three.jsコードの新規作成・修正時 |
| **GPT** | レビュアー/アーキテクト | 俯瞰的構造改善、運用設計、セカンドオピニオン | 品質検証、設計議論、リファクタリング時 |

### 責務境界（明確化）

| 作業 | 担当 | 注意 |
|------|------|------|
| シェーダー新規作成・GLSL修正 | **Gemini** | — |
| Three.jsメッシュ・マテリアル | **Gemini** | — |
| コードレビュー・構造改善 | **GPT** or Gemini review | — |
| config/devパネル/HTML/CSS | **Claude直接** | — |
| **関数シグネチャ・インターフェース設計** | **Claude** | 擬似コード・引数定義まで |
| **関数の中身（実装）** | **Gemini** or **Claude Code** or **Codex** | Claudeは実装を書かない |
| **指示書作成** | **Claude**（📋エージェント経由） | 自動生成 |

> **原則**: 外部エージェント利用は `skills/project-management-agent.md` の自律判断ルールに従う。ユーザーの明示指示がある場合はそれを最優先する。

---

## 2. コンテキスト共有：Context Layer

### 設計思想

> 各エージェントに渡す情報は「最小限かつ十分」。
> 判断基準: **そのエージェントが「なぜ」と「どこまで」を理解できる最小の情報量**。

### Layer構成

| Layer | 内容 | 必須/任意 | 推定トークン |
|---|---|---|---|
| **L0: Grounding** | ファイルツリー + 技術スタック | **必須（毎回）** | ~300 |
| **L1: スキル** | ロール別ガイドライン（skills/から選択） | タスクに応じて1-2枚 | ~400/枚 |
| **L2: タスク** | TASK.md（4点セット + Visual Specs） | **必須** | 変動 |
| **L3: 履歴** | LEARNINGS.md + 前回結果 | 関連時のみ | ~200 |

### L0: Grounding（最重要 — 毎回必ず渡す）

```
Project: kesson-space（欠損駆動思考の3Dビジュアライゼーション）
Tech: Three.js 0.160.0, ES Modules (importmap), no build tools
Hosting: GitHub Pages (path: /kesson-space/)
Config: src/config.js = Single Source of Truth

## Current Tree
（以下のコマンドで生成）
tree -I 'node_modules|.git|dist|__pycache__|uv.lock' --dirsfirst -L 3
```

### L1: スキル（skills/ から選択ロード）

**1回のプロンプトで読み込むのは1〜2ファイルまで**。全部連結して読ませない。

| スキルファイル | 対象 | 内容 |
|---|---|---|
| `skills/shared-quality.md` | 全エージェント | 命名規約、禁止事項、パフォーマンス基準 |
| `skills/shader-impl.md` | Gemini | Visual Direction、GLSL作法、出力ルール |
| `skills/review-gates.md` | GPT | レビュー観点、品質ゲート、評価基準 |
| `skills/orchestrator.md` | Claude | 分解・委譲・統合の手順 |
| `skills/session-workflow.md` | Claude | セッション管理ワークフロー（deprecated: 参照のみ） |
| `skills/project-management-agent.md` | Claude | 委譲判断・指示書生成 |
| `skills/devlog-generation.md` | Claude/Codex | devlog生成ワークフロー |

### L2: タスク（context-pack/）

**4点セットが必ず揃うこと。ファイル数は柔軟。**

#### 通常タスク: 4ファイル構成

```
context-pack/
  TASK.md          ← Why + Scope + Visual Specs
  FILES.md         ← 対象ファイル・編集範囲
  CONSTRAINTS.md   ← 制約 + SkillBundle指定
  ACCEPTANCE.md    ← 完了条件（省略禁止）
```

#### マイクロタスク: SINGLE.md に圧縮

→ `context-pack/SINGLE.md.template` を参照

**使い分け基準**: 対象ファイルが1つ、変更が10行以下 → SINGLE.md。それ以上 → 4ファイル。

### L3: 履歴

→ `skills/LEARNINGS.md` を参照

---

## 3. ハンドオフ規格

### Claude → Gemini（実装依頼）

```
渡すもの:
  L0: Grounding（ファイルツリー必須）
  L1: skills/shader-impl.md（+ shared-quality.md 必要時）
  L2: TASK.md（Visual Specs必須）+ FILES.md + CONSTRAINTS.md + ACCEPTANCE.md
  L3: LEARNINGS.md（関連する教訓があれば）
```

### Claude → Claude Code / Codex（実装依頼）

```
渡すもの:
  指示書（skills/project-management-agent.md のテンプレート）
  ワークツリーパス指定必須
  ブランチ名指定必須
```

### Claude → GPT（レビュー依頼）

```
渡すもの:
  L0: Grounding
  L1: skills/review-gates.md
  L2: レビュー対象コード + 「このコードはGeminiが生成した」の一文
  Focus: パフォーマンス / 構造 / 可読性 のうち何を重視するか
```

### Gemini/GPT → Claude（成果物の戻し）

```
戻すもの:
  1. コード差分（patch or 全文。変更箇所に // CHANGED(YYYY-MM-DD) コメント）
  2. 設計メモ（5-10行。なぜこう書いたか）
  3. 再現手順（ローカルでの確認コマンド or 操作手順）
  4. 残課題（TODO。あれば）
```

---

## 4. スキル更新ルール

### 権限

| 操作 | Claude | Gemini | GPT | ユーザー |
|------|--------|--------|-----|---------|
| skills/ 閲覧 | ○ | ○ | ○ | ○ |
| skills/ 修正提案 | ○ | ○ | ○ | ○ |
| skills/ 正本マージ | ○ | ✕ | ✕ | ○ |
| LEARNINGS.md 追記 | ○ | ○ | ○ | ○ |

### 更新タイミング

- **LEARNINGS.md**: タスク完了時に気づいたことを随時追記
- **skills/*.md**: 月1回の棚卸し or 明らかな問題発見時
- **context-pack/テンプレート**: 運用が安定するまでは柔軟に改善

---

## 5. ディレクトリ配置

```
kesson-space/
├── skills/
│   ├── shared-quality.md          ← 全エージェント共通の品質基準
│   ├── shader-impl.md             ← Gemini用: Visual Direction、GLSL作法
│   ├── review-gates.md            ← GPT用: レビュー観点
│   ├── orchestrator.md            ← Claude用: 分解・委譲手順
│   ├── session-workflow.md        ← Claude用: セッション管理（deprecated）
│   ├── project-management-agent.md ← Claude用: 委譲判断・指示書生成
│   ├── devlog-generation.md       ← devlog生成ワークフロー
│   └── LEARNINGS.md               ← 運用の教訓（手動更新）
│
├── context-pack/
│   ├── SINGLE.md.template         ← マイクロタスク用テンプレート
│   └── （タスクごとに TASK.md 等を作成。完了後は削除 or archive/）
│
├── docs/
│   ├── AGENT-RULES.md             ← 本ファイル（上位方針）
│   └── ...
```

---

## 6. PROMPT-STRUCTURE.md との関係

本文書 = **マルチエージェント運用の上位方針**。
PROMPT-STRUCTURE.md = **Gemini向けの具体的テンプレート**（引き続き使用可）。

将来的にPROMPT-STRUCTURE.mdの内容は `skills/shader-impl.md` と `context-pack/TASK.md` テンプレートに分解・吸収される可能性がある。

---

## 7. 🔎 PKガード（Project Knowledge管理）

### Tier分類

| Tier | ファイル | 参照タイミング |
|------|---------|---------------|
| 1 | README.md, AGENTS.md, docs/README.md | セッション開始時に必ず |
| 2 | WORKFLOW.md, AGENT-RULES.md, ARCHITECTURE.md, ENVIRONMENT.md, TESTING.md, CONCEPT.md | タスクに応じて |
| 3 | docs/prompts/*, docs/issues/* | 必要時のみ |

### 🔎PKガードの監視項目（常駐）

PKガードはClaudeが**常時内部的に実行する**常駐ガード。

| # | 監視項目 | 判定基準 | アクション |
|---|---------|---------|----------
| PG-1 | セッション冒頭でTier 2/3を読んでいないか | Tier 1のみ許可 | タスク確定後に参照 |
| PG-2 | 完了済みドキュメントを読んでいないか | ISS-001(✅完了)等 | 完了済みは無視 |
| PG-3 | Tier 3を不要に参照していないか | Gemini作業時のみ | 依頼時以外は無視 |
| PG-4 | 1ターンで参照するPKファイル数 | 3ファイル超 | 本当に全部必要か再確認 |
| PG-5 | PKとGitHub正本の乖離 | 更新日付 | 乖離検出時にユーザーに同期を促す |

### PK推奨構成（最小セット）

| ファイル | Tier | PKに必要 |
|---------|------|---------|
| README.md | 1 | ✅ 必須 |
| AGENTS.md | 1 | ✅ 必須 |
| docs/README.md | 1 | ✅ 必須 |
| GitHub Issues | 1 | ✅ 必須（正本） |
| docs/WORKFLOW.md | 2 | ✅ 推奨 |
| docs/CONCEPT.md | 2 | ✅ 推奨 |
| docs/ARCHITECTURE.md | 2 | ⚠️ 技術作業時のみ |
| docs/AGENT-RULES.md | 2 | ⚠️ エージェント作業時のみ |
| docs/prompts/* | 3 | ⚠️ 指示書参照時のみ |
| docs/issues/* | 3 | ⚠️ 過去判断参照時のみ |

---

## 8. 🩺 セッションヘルスガード

### 背景

kesson-spaceではシェーダーファイル（GLSL 200行超）やGemini MCP応答の蓄積により、コンテキストウィンドウが逼迫しセッションがフリーズするケースが発生している。

### 監視項目

| # | 監視項目 | 閾値 | アクション |
|---|---------|------|----------
| SH-1 | シェーダーファイル全文読み込み | 2ファイル以上/セッション | セクション指定に切替を提案 |
| SH-2 | 1ターンの出力長 | 長大なコード出力 | 分割出力を提案 |
| SH-3 | 累積ファイル参照数 | 8ファイル超 | 参照整理を提案 |
| SH-4 | 連続ツール呼び出し | 5回連続 | 中間確認を挟む |
| SH-5 | Gemini MCP応答の蓄積 | コード全文返却時 | diffのみ抽出 |
| SH-6 | 4エージェント分析 | 起動前 | コンテキスト残量を事前判定 |

### 高リスクパターン

| パターン | 具体例 | 予防策 |
|---------|--------|--------|
| シェーダー全文ループ | vortex.js読み込み→修正→再読み込み | 1回目でdiff管理に移行 |
| 修正済み確認の連鎖 | dev-panel→main.js→scroll-ui→config | IssueコメントとPR差分を先に確認 |
| Gemini出力の蓄積 | 生成コード200行×3回 | 最新版のみ保持 |
| 4エージェント分析+実装 | 分析で大量出力→そのまま実装 | 別セッションに分割 |

### 発動タイミング

🩺セッションヘルスガードは**Claudeが内部的に常時監視**。以下のタイミングで自動チェック:

- **タスク受領時**: 負荷カテゴリ判定（🟢低/🟡中/🔴高）
- ファイル読み込み前（SH-1, SH-3）
- ツール呼び出し前（SH-4, SH-5）
- 長文出力の開始前（SH-2）
- 4エージェント分析の開始前（SH-6）

閾値を超えた場合の報告形式:

```
⚠️ セッションヘルス: [SH-N] [監視項目]
状況: [具体的な状況]
提案: [セッション分割 / 参照整理 / diff管理への切替 など]
```

### 永続性の保証（3層担保）

| 層 | 仕組み | 役割 |
|----|--------|------|
| **Memory** | Claudeの永続記憶にSH-1〜SH-6の要約を記録 | セッションをまたいでも消えない |
| **WORKFLOW.md §1.5** | セッション開始手順に負荷事前判定を組み込み | タスク着手前の強制チェック |
| **本節（§8）** | 詳細な監視項目・閾値・対応策 | 参照先 |

---

## 9. 策定経緯

| ラウンド | 内容 |
|---------|------|
| R1 | 三者に同一質問「コンテキスト共有の最適設計」→ 初期案収集 |
| R1→R2 | ChatGPTの提案をGeminiに、Geminiの提案をChatGPTに相互レビュー |
| R2 | 収束: 4点セット×動的ロード共存、LEARNINGS.md、ファイルツリー必須 |
| v1.1 | レビュー指摘反映: 配置整合、HTML例外、CHANGED日付化 |
| v1.2 | 🩺セッションヘルスガードを常駐エージェントに追加 |
| v1.3 | ドキュメント階層再構成に伴い、PKガード・セッションヘルス詳細を本ファイルに統合 |
| v1.4 | 📋プロジェクト管理エージェント追加、委譲先にClaude Code/Codex追加 |
| v1.5 | 🔍探索モード追加（§10）— 並列エージェント呼び出しパターン標準化 |
| v1.6 | Issue-Centric整合。CURRENT/TODO依存を削除し自律判断チャーターを反映 |
| v1.7 | 自律委譲方針をPMルールブックに統合。deprecatedスキルの扱いを明記 |

---

## 10. 🔍 探索モード（Exploration Mode）

### 背景

単一エージェント（Claude）の視点では発想が限定される場合がある。設計判断・技術選定・アーキテクチャ決定など、**多角的な検討が必要な課題**では、複数エージェントの並列呼び出しによるアイディア収集が有効。

> 参考: 公式 `/mnt/skills/examples/skill-creator` のExecutor/Grader/Comparator/Analyzerパターン

### 発動トリガー

以下のキーワード・状況で探索モードを提案:

| トリガー | 例 |
|---------|-----|
| 「アイディアが不足」「視点が足りない」 | 「あなたのアイディアが不足してる」 |
| 「多角的に検討」「ブレストしたい」 | 「いろんな観点で考えたい」 |
| 「エージェントを手配」「並列で聞きたい」 | 「複数のAIに聞いてみたい」 |
| 設計判断で選択肢が多い | 技術選定、アーキテクチャ決定 |
| Claudeの提案が浅い/偏っている | ユーザーからの指摘 |

### ワークフロー

```
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: Ideation（並列アイディア生成）                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ Gemini  │  │ Codex   │  │ Web検索  │  │ GPT     │        │
│  │ 技術実装 │  │ 効率性  │  │ 外部事例 │  │ 構造設計 │        │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘        │
│       │           │           │           │               │
│       └───────────┴───────────┴───────────┘               │
│                       ↓                                    │
├─────────────────────────────────────────────────────────────┤
│  Phase 2: Comparison（ブラインド比較）                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 案A / 案B / 案C / 案D として匿名化                    │   │
│  │ Rubric評価: 実現性 / 保守性 / UX / パフォーマンス    │   │
│  └─────────────────────────────────────────────────────┘   │
│                       ↓                                    │
├─────────────────────────────────────────────────────────────┤
│  Phase 3: Analysis（統合・DT判断支援）                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 勝者の強み / 敗者の弱み / 改善提案                    │   │
│  │ → DTに判断材料を提示                                 │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Building Blocks

| Block | 役割 | 担当候補 | 出力 |
|-------|------|---------|------|
| **Ideator** | 特定観点からのアイディア生成 | Gemini / Codex / Web検索 / GPT | 提案文 + 根拠 |
| **Comparator** | ブラインド比較・rubric評価 | Claude（別視点）or GPT | 勝者 + スコア + 理由 |
| **Analyzer** | 事後分析・改善提案 | Claude（現セッション） | 統合レポート |

### Ideator観点マトリクス

課題タイプに応じて、どのエージェントにどの観点を担当させるか:

| 課題タイプ | Gemini | Codex | Web検索 | GPT |
|-----------|--------|-------|---------|-----|
| **UI/UX設計** | Three.js実装 | コード効率 | 類似サイト事例 | 情報設計 |
| **アーキテクチャ** | パフォーマンス | モジュール化 | ベストプラクティス | 拡張性 |
| **技術選定** | 実装難易度 | 保守コスト | 採用事例 | トレードオフ |
| **シェーダー** | GLSL実装 | — | 表現手法 | — |

### ハンドオフ規格（探索モード用）

#### Claude → Ideator（並列）

```
渡すもの:
  課題文: [具体的な問い]
  観点指定: [このエージェントに期待する視点]
  制約: [技術スタック、パフォーマンス要件など]
  出力形式: 
    - 提案（3-5行）
    - 根拠（なぜこれが良いか）
    - トレードオフ（デメリット・懸念）
```

#### Ideator → Comparator

```
渡すもの:
  案A〜D: [各Ideatorの出力を匿名化]
  評価軸: 
    - 実現性（1-5）
    - 保守性（1-5）
    - UX/美学（1-5）
    - パフォーマンス（1-5）
  ※ どのエージェントがどの案かは伏せる
```

#### Comparator出力形式

```json
{
  "winner": "B",
  "scores": {
    "A": { "実現性": 3, "保守性": 4, "UX": 2, "パフォーマンス": 3, "total": 12 },
    "B": { "実現性": 5, "保守性": 4, "UX": 4, "パフォーマンス": 4, "total": 17 },
    "C": { "実現性": 4, "保守性": 3, "UX": 3, "パフォーマンス": 5, "total": 15 },
    "D": { "実現性": 2, "保守性": 5, "UX": 4, "パフォーマンス": 3, "total": 14 }
  },
  "reasoning": "案Bは実現性とUXのバランスが最も優れている..."
}
```

#### Analyzer出力形式

```
## 探索結果サマリ

### 勝者: 案B（Gemini提案）
- 強み: [具体的な利点]
- 採用時の注意: [実装上の懸念]

### 次点: 案C（Codex提案）
- 部分採用候補: [取り入れられる要素]

### 改善提案
1. [案Bに案Cの要素を組み合わせる提案]
2. [追加検討が必要な点]

### DT判断ポイント
- [最終決定に必要な情報・確認事項]
```

### 注意事項

| 項目 | ルール |
|------|--------|
| セッションヘルス | 探索モードは🔴高負荷。Phase 1完了後に中間確認を挟む |
| 並列上限 | 1回のIdeationで呼び出すエージェントは**最大4つ** |
| 省略可能 | 単純な課題ではPhase 2（Comparison）を省略可 |
| DT権限 | 最終判断は常にDT（ユーザー）。Analyzerは判断材料提供のみ |

### クイック呼び出し

探索モードの簡易起動フレーズ:

```
「T-XXXについて探索モードで検討したい」
「この課題、複数エージェントでブレストして」
「アイディアが足りない、並列で集めて」
```

→ Claudeは§10ワークフローを開始
