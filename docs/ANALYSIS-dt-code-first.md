# DT Code-first ワークフロー 多角分析

**作成日**: 2026-02-16  
**分析対象**: 「Chat で指示書作成 → DT Code に渡す」フローの実現可能性と設計  

---

## DT の方針（前提の修正）

1. **PC拘束からの解放**が最大の動機。CLI の機能不足ではない
2. **CSS/Three.js の視覚テストはどの CLI でもできない**。E2E テスト化で対応するため、ツール差は無関係
3. **指示書は Chat（本プロジェクト）で作成**したい
4. **DT Code で可能なら DT Code。ダメなら CLI へフォールバック**
5. 理想: Chat が指示書を push → DT Code に「最新の指示書を読んで」で渡せる仕組み

---

## エージェント 1: ワークフロー設計者

### 提案フロー

```
[Chat] 指示書作成 → docs/prompts/NEXT-TASK.md として push
                                    ↓
[DT Code] 「docs/prompts/NEXT-TASK.md を読んで実行して」
                                    ↓
[DT Code] 実装 → コミット → push
                                    ↓
[Chat] diff 確認 → 承認 → main マージ → TODO 更新
```

### NEXT-TASK.md 方式のメリット

- DT Code への指示が常に1行で済む（「最新の指示書を読んで実行して」）
- 指示書の品質管理を Chat 側に集約できる
- 指示書自体が git 管理されるので履歴が残る
- 重複レポート問題も解決（指示書が正本、完了後にリネーム or 移動）

### ファイル命名規約案

```
docs/prompts/NEXT-TASK.md          ← 常に「次のタスク」がここにある
docs/prompts/done/T-040-11.md      ← 完了した指示書はここに移動
```

DT Code は毎回 `docs/prompts/NEXT-TASK.md` を読むだけ。Chat 側が中身を差し替える。

### 懸念

- DT Code が NEXT-TASK.md を読んだ後、別のことを始めるリスク
  → 指示書の冒頭に「この指示書の内容のみ実行すること」を明記
- NEXT-TASK.md が空 or 古い状態で DT Code を起動するリスク
  → 指示書にタスクID + 日付を含め、DT Code 側で鮮度チェック

---

## エージェント 2: タスク仕分け再評価者

### 前回の仕分けの問題点

前回レポートは「視覚確認の可否」でタスクを仕分けた。しかし DT の指摘により:

- **視覚確認は CLI でもできない** → 仕分け基準として無効
- **E2E テストが動けば同じ** → 仕分け基準は「E2E テストでカバーできるか」に変わる

### 新しい仕分け基準

```
DT Code で可能な条件:
  1. git 操作ができる（fetch/checkout/commit/push）
  2. ファイル編集ができる
  3. node / python が実行できる（テスト実行）

DT Code で不可能な条件:
  → 現時点でほぼない（未検証事項を除く）
```

### 再仕分け結果

| カテゴリ | タスク | 判定 |
|----------|--------|------|
| JS リファクタリング | T-016, 017, 019, 021, 022 | ✅ DT Code |
| JS 機能追加 | T-040-11, T-040-08 | ✅ DT Code |
| CSS/HTML 変更 | T-018, T-043 | ✅ DT Code（視覚確認は後追い） |
| ドキュメント | T-006, T-012, T-040-12 | ✅ DT Code |
| CI/設定 | T-038 | ✅ DT Code |
| プロセス改善 | T-042, T-046, T-047 | ✅ Chat + DT Code |
| E2E テスト拡充 | T-043 のテスト部分 | ✅ DT Code |
| シェーダー実装 | Gemini MCP 連携 | ⚠️ 要検証（Gemini MCP が DT Code 環境で使えるか） |
| パフォーマンス計測 | T-007 | ⚠️ DevTools 必須部分は PC、スクリプト化できる部分は DT Code |
| 実機テスト | T-015 | ❌ 物理デバイス操作が必要 |

### 結論

**前回: 54% → 今回: 約 90% が DT Code 対応可能**

CLI フォールバックが必要なケースは:
- Gemini MCP 連携（シェーダー生成）→ 未検証
- DevTools が必須のプロファイリング → PC 作業
- 実機テスト → 物理操作

---

## エージェント 3: リスク分析者

### リスク 1: DT Code のコンテキスト上限（未検証）

**影響**: 大規模リファクタリング（T-019: main.js 分割）で途中で切れる可能性
**軽減策**: 
- 指示書を Step 単位で分割し、各 Step を独立コミット可能にする
- 「Step 1 が終わったらコミットして次の指示書を読め」方式
**検証方法**: まず小タスク（T-040-13: ブランチ掃除）で試運転

### リスク 2: DT Code のセッション持続性（未検証）

**影響**: スマホのバッテリー切れ・アプリ切り替えで中断
**軽減策**: 指示書に「各 Step 完了後に必ず commit + push」を含める
**検証方法**: 意図的に中断→復帰テスト

### リスク 3: NEXT-TASK.md の衝突

**影響**: Chat が指示書を更新中に DT Code が古い版を読む
**軽減策**: 
- Chat が push 完了してから DT Code を起動する（手動の順序制御）
- 指示書にタイムスタンプを含める

### リスク 4: ブランチ操作の失敗

**影響**: 前回検証で判明済み（main のみクローン問題）
**軽減策**: 指示書テンプレートの「前提手順」で解決済み
**残リスク**: ほぼゼロ（テンプレートが正しければ）

### リスク 5: DT Code が AGENTS.md / NEXT-TASK.md を無視

**影響**: 指示と異なる作業をする
**軽減策**: 
- 指示書の冒頭を強い制約文にする（「この文書の指示のみ実行」）
- 完了条件を明確にする（チェックリスト形式）

### 総合リスク評価

**高リスク**: なし
**中リスク**: コンテキスト上限、セッション持続性（ともに未検証）
**低リスク**: ブランチ操作、指示無視（テンプレートで軽減可能）

→ **小タスクで試運転してから本格移行が妥当**

---

## エージェント 4: 運用効率化者

### 「最新の指示書を読んで」を最大限シンプルにする

DT がスマホから DT Code に渡す文言は極力短くしたい。理想は:

```
docs/prompts/NEXT-TASK.md を読んで、その指示通りに実装して。
```

これだけで動くために、指示書側に必要な情報を全て含める:

1. **前提手順**（git fetch/checkout）
2. **ゴール**（完了条件）
3. **実装手順**（具体的なコード変更）
4. **テスト**（実行コマンド）
5. **完了後**（commit/push コマンド）
6. **制約**（この指示書の内容のみ実行、claude/* ブランチ禁止）

### Chat 側の指示書作成フロー

```
DT: 「T-040-11 の指示書を作って push して」
Chat: TODO 確認 → 指示書生成 → docs/prompts/NEXT-TASK.md に push → 完了報告
DT: DTアプリ「コード」を開いて1行入力
```

### 完了後の後処理フロー

```
DT: 「DT Code が終わった。diff 見て」
Chat: git log/diff 確認 → 問題なければマージ → NEXT-TASK.md を done/ に移動 → TODO 更新 → push
```

### 承認ワークフローのスマホ最適化

DT が承認で確認すべきことを最小化:

- Chat が diff サマリを3行以内で提示
- 「マージしていい？」の Yes/No だけ
- TODO 更新も Chat が自動で行う

---

## 統合結論

### 実現可能性: 高い

- 技術的障壁はほぼない（前回検証で確認済み）
- 未検証項目（コンテキスト上限、セッション持続性）は小タスクで検証可能
- タスクの約 90% が DT Code 対応可能

### 推奨アクション（優先順）

1. **即実行**: NEXT-TASK.md 方式の試運転
   - 対象: T-040-13（ブランチ掃除）— 最小タスク
   - Chat で指示書作成 → push → DT Code で実行 → Chat で確認
   - 目的: フロー全体の検証

2. **試運転成功後**: 指示書テンプレート v2 確定 + WORKFLOW.md 更新

3. **本格運用**: JS リファクタリング系（T-016/017）を DT Code で投入

### CLI フォールバック基準

以下の場合のみ CLI を使用:
- Gemini MCP 連携が必要（シェーダー生成）
- DT Code のコンテキスト上限を超える大タスク
- DevTools による計測が必須

それ以外は全て DT Code-first。

---

## 参照

- `docs/RESEARCH-web-code-main-tool.md` — 初回分析レポート
- `docs/RESEARCH-web-claude-code.md` — Web版 Claude Code 初回検証
- `docs/TODO-kesson-articles.md` — T-040 タスク詳細
- `docs/TODO.md` — 全タスクバックログ
