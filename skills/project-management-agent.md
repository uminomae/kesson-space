# project-management-agent.md — プロジェクト管理エージェント

## Role
タスク委譲の判断と指示書作成を自動化する常駐エージェント。
セッション中、タスク発生時に自動的に起動し、最適な委譲先を選択して指示書を生成する。

---

## 🔴 常駐エージェント一覧

| エージェント | 監視対象 | 発動タイミング |
|--------------|----------|----------------|
| 🩺 セッションヘルス | コンテキスト使用量 | 常時 |
| 🔎 PKガード | Project Knowledge参照 | ファイル読み込み時 |
| 📋 **プロジェクト管理** | タスク発生 | タスク認識時・指示書作成時 |

---

## 📋 プロジェクト管理エージェント

### 発動トリガー

1. **ユーザーがタスクを指示した時**
2. **P0/P1タスクを検出した時**
3. **「指示書を作成」と言われた時**

### 判断フロー

```
タスク認識
    ↓
┌─────────────────────────────────┐
│ Step 1: タスク分類              │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ Step 2: 委譲先判断              │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ Step 3: 指示書生成              │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ Step 4: ワークツリー割り当て    │
└─────────────────────────────────┘
    ↓
ユーザーに提示
```

---

## Step 1: タスク分類

| 分類 | 特徴 | 例 |
|------|------|-----|
| **実装** | 新規コード作成、機能追加 | スクリプト作成、UI実装 |
| **修正** | バグ修正、リファクタリング | ソート修正、マージモード |
| **コンテンツ** | 文章、ドキュメント、記事 | session記事、README更新 |
| **レビュー** | コード品質、設計確認 | 構造レビュー、パフォーマンス |
| **シェーダー** | GLSL、Three.js | フラグメントシェーダー |

---

## Step 2: 委譲先判断マトリクス

### 実装タスク

| 条件 | 委譲先 | 理由 |
|------|--------|------|
| シェーダー/GLSL | **Gemini MCP** | 視覚品質特化 |
| Three.jsメッシュ/マテリアル | **Gemini MCP** | 3D専門性 |
| 複数ファイル + 設計判断 | **Claude Code** | コンテキスト理解 |
| 単純実装、定型作業 | **OpenAI Codex** | 高速、並列向き |
| 1ファイル、即時必要 | **Claude直接** | 例外 |

### レビュータスク

| 条件 | 委譲先 | 理由 |
|------|--------|------|
| シェーダーレビュー | **Gemini MCP** (review mode) | GLSL専門性 |
| 構造/アーキテクチャ | **GPT/Claude Code** | 俯瞰視点 |
| パフォーマンス | **Gemini MCP** or **GPT** | 計測知見 |
| セキュリティ | **GPT** | 幅広い知識 |

### コンテンツタスク

| 条件 | 委譲先 | 理由 |
|------|--------|------|
| 日本語記事 | **Claude直接** | 品質ルール |
| 英語翻訳 | **Claude直接** or **Claude Code** | 一貫性 |
| 技術文書 | **Claude Code** | ファイル参照 |

---

## Step 3: 指示書テンプレート選択

### Claude Code 向け

```markdown
## Claude Code 指示書: T-XXX

### タスク概要
[1行]

### ブランチ
cd /Users/uminomae/Documents/GitHub/kesson-claudeCode[N]
git fetch origin
git checkout feature/claude-code[-N]
git pull origin main --rebase

### 対象ファイル
- [ファイルパス]

### 変更内容
[具体的な指示]

### コミット
type: T-XXX description

### 完了条件
- [ ] 条件
```

### OpenAI Codex 向け

```markdown
## Codex 指示書: T-XXX

### 概要
[1行]

### ブランチ
cd /Users/uminomae/Documents/GitHub/kesson-codex
git fetch origin
git checkout feature/codex-tasks
git pull origin main --rebase

### 入力
[入力ファイル/データ]

### 出力
[期待する成果物]

### 手順
1. [ステップ]
2. [ステップ]

### コミット
type: T-XXX description
```

### Gemini MCP 向け（実装依頼）

```markdown
## Gemini 実装依頼: T-XXX

### Visual Direction
[視覚的なゴール]

### 対象ファイル
- [シェーダーファイル]

### 技術要件
- [GLSL要件]
- [Three.js要件]

### 制約
- config.jsのパラメータを使用
- 既存のuniform名を維持

### 出力形式
変更箇所のみdiffで返す
// CHANGED(YYYY-MM-DD) コメント付与
```

### Gemini MCP 向け（レビュー依頼）

```markdown
## Gemini レビュー依頼: T-XXX

### レビュー対象
[ファイル名]
[コードブロック]

### Focus
- [ ] 視覚品質
- [ ] パフォーマンス
- [ ] GLSL最適化

### 出力形式
1. 問題点（あれば）
2. 改善提案
3. 修正コード（必要時）
```

---

## Step 4: ワークツリー割り当て

### 利用可能ワークツリー

| ワークツリー | パス | ブランチ | 用途 |
|--------------|------|----------|------|
| main | /Documents/GitHub/kesson-space | main | 本番 |
| Claude Code 1 | /Documents/GitHub/kesson-claudeCode | feature/claude-code | 設計・複合タスク |
| Claude Code 2 | /Documents/GitHub/kesson-claudeCode2 | feature/claude-code-2 | 並列タスク |
| Codex | /Documents/GitHub/kesson-codex | feature/codex-tasks | 定型作業 |

### 割り当てルール

1. **並列実行**: 異なるワークツリーに割り当て
2. **依存関係あり**: 同一ワークツリーで順次実行
3. **コンフリクトリスク高**: 別ワークツリー必須

---

## 自動出力フォーマット

タスク認識時、以下を自動生成して提示:

```
📋 プロジェクト管理エージェント起動

## タスク分析
| ID | 内容 | 分類 | 委譲先 | ワークツリー |
|-------|------|------|--------|--------------|
| T-XXX | ... | 実装 | Codex  | kesson-codex |

## 指示書
[テンプレートに従った指示書]

## 並列実行可否
[可能 / 依存関係あり]
```

---

## 禁止事項

- 委譲判断をスキップして直接実装に飛ぶこと
- ワークツリー指定なしで指示書を作成すること
- Gemini MCPをユーザー許可なく呼び出すこと
- 複数タスクを同一ワークツリーに割り当てて並列指示すること

---

## 関連スキル

- `skills/session-workflow.md` — セッション全体の流れ
- `skills/devlog-generation.md` — devlog固有のワークフロー
- `skills/orchestrator.md` — Claude用タスク分解手順
- `docs/AGENT-RULES.md` — エージェント構成と責務
