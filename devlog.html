<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>devlog - Kesson Space</title>
  <link rel="icon" href="./favicon.ico">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts — Noto Serif JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400&amp;display=swap" rel="stylesheet">

  <style>
    :root {
      --overlay-bg-rgb: 5, 5, 8;
      --overlay-opacity-top: 0.3;
      --overlay-opacity-mid: 0.5;
      --overlay-opacity-bottom: 0.7;
    }

    body {
      margin: 0;
      padding: 0;
      background: #050508;
      color: #e2e8f0;
      font-family: "Noto Serif JP", "Yu Mincho", "MS PMincho", serif;
    }

    /* Three.js背景コンテナ */
    #bg-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }
    /* コンテンツオーバーレイ（可読性確保） */
    #content-overlay {
      position: relative;
      z-index: 1;
      background: linear-gradient(
        to bottom,
        rgba(var(--overlay-bg-rgb), var(--overlay-opacity-top)) 0%,
        rgba(var(--overlay-bg-rgb), var(--overlay-opacity-mid)) 30%,
        rgba(var(--overlay-bg-rgb), var(--overlay-opacity-bottom)) 100%
      );
      min-height: 100vh;
    }

    .devlog-shell {
      max-width: 960px;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: rgba(220, 230, 245, 0.8);
      text-decoration: none;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border: 1px solid rgba(100, 150, 255, 0.25);
      padding: 8px 14px;
      border-radius: 2px;
      background: rgba(100, 150, 255, 0.08);
      transition: color 0.3s ease, border-color 0.3s ease, background 0.3s ease;
    }
    .back-link:hover {
      color: rgba(255, 255, 255, 0.95);
      border-color: rgba(100, 150, 255, 0.5);
      background: rgba(100, 150, 255, 0.16);
    }
    .devlog-cover {
      width: 100%;
      height: auto;
      max-height: none;
      object-fit: contain;
      object-position: center center;
      border-radius: 6px;
      box-shadow: 0 10px 28px rgba(10, 14, 26, 0.6);
    }
    .devlog-cover-note {
      display: block;
      margin-top: -8px;
      margin-bottom: 14px;
      color: rgba(150, 190, 245, 0.82);
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }
    .devlog-meta {
      font-size: 0.85rem;
      color: rgba(180, 200, 230, 0.6);
      letter-spacing: 0.08em;
    }
    .devlog-error {
      padding: 16px 18px;
      border: 1px solid rgba(100, 150, 255, 0.2);
      background: rgba(12, 16, 30, 0.8);
      color: rgba(220, 230, 245, 0.85);
      border-radius: 6px;
    }
    .version-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      font-size: clamp(0.4rem, 1.8vmin, 0.65rem);
      color: rgba(150, 175, 210, 0.35);
      font-family: 'Georgia', serif;
      letter-spacing: 0.08em;
      background: transparent;
      padding: 0;
    }

    /* ============================
       Devlog detail content
       ============================ */
    .session-content {
      color: #94a3b8;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }
    .session-content h1,
    .session-content h2,
    .session-content h3 {
      color: #e2e8f0;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
    }
    .session-content h1 { font-size: 1.3rem; }
    .session-content h2 { font-size: 1.1rem; }
    .session-content h3 { font-size: 0.95rem; }
    .session-content p {
      font-size: 0.9rem;
      line-height: 1.8;
      color: #94a3b8;
      margin-bottom: 1em;
      font-family: "Noto Serif JP", "Yu Mincho", serif;
    }
    .session-content ul,
    .session-content ol {
      font-size: 0.9rem;
      line-height: 1.8;
      color: #94a3b8;
      padding-left: 1.5em;
    }
    .session-content code {
      background: rgba(100, 150, 255, 0.1);
      padding: 0.15em 0.4em;
      border-radius: 3px;
      font-size: 0.85em;
    }
    .session-content pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 1em;
      border-radius: 4px;
      overflow-x: auto;
    }
    .session-content a {
      color: #f59e0b;
    }

    /* prefers-reduced-motion対応 */
    @media (prefers-reduced-motion: reduce) {
      #bg-container canvas {
        animation: none !important;
      }
      #content-overlay {
        background: rgba(var(--overlay-bg-rgb), 1);
      }
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "./vendor/three@0.160.0/build/three.module.js",
        "three/addons/": "./vendor/three@0.160.0/examples/jsm/",
        "marked": "https://cdn.jsdelivr.net/npm/marked@15.0.7/lib/marked.esm.js",
        "dompurify": "https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.es.mjs"
      }
    }
  </script>
</head>
<body>
  <div class="version-badge">v0.3.0-t046</div>
  <!-- Three.js背景 -->
  <div id="bg-container"></div>

  <!-- コンテンツオーバーレイ -->
  <div id="content-overlay">
    <main class="container py-5 devlog-shell">
      <a class="back-link mb-4" href="index.html">← 一覧に戻る</a>

      <div class="mb-4">
        <div class="devlog-meta mb-2" id="devlog-meta"></div>
        <h1 class="h3 text-light mb-3" id="devlog-title">Loading...</h1>
        <img id="devlog-cover" class="devlog-cover mb-4 d-none" alt="Session cover">
        <small id="devlog-cover-note" class="devlog-cover-note d-none"></small>
      </div>

      <div id="devlog-error" class="devlog-error d-none"></div>
      <div id="devlog-content" class="session-content"></div>
    </main>
  </div>

  <!-- Image Lightbox Modal -->
  <div class="modal fade" id="imageLightboxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body p-0 text-center">
          <img id="lightbox-image" class="img-fluid" style="max-height: 80vh; cursor: pointer;" alt="Enlarged cover">
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Three.js背景 -->
  <script type="module" src="./src/pages/devlog-bg.js"></script>

  <!-- Devlogコンテンツローダー -->
  <script type="module">
    import { marked } from 'marked';
    import DOMPurify from 'dompurify';

    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
    });

    const DEVLOG_RETURN_INTENT_KEY = 'kesson.devlog.return-intent.v1';
    const SCROLL_RESTORATION_ONCE_KEY = 'kesson.scroll-restoration-once.v1';
    const DEVLOG_DEFAULT_COVER = './assets/devlog/covers/default.svg';
    const SUPPORTED_LANGS = new Set(['ja', 'en']);
    const UI = {
      ja: {
        backToIndex: '← 一覧に戻る',
        loading: '読み込み中...',
        devlogLabel: 'devlog',
        sessionIdMissing: 'セッションIDが見つかりません。',
        sessionNotFound: '指定されたセッションが見つかりません。',
        sessionLoadFailed: 'セッションデータの読み込みに失敗しました。',
        coverFallbackNote: 'カバー画像の英語版は準備中です',
      },
      en: {
        backToIndex: '← Back to list',
        loading: 'Loading...',
        devlogLabel: 'Devlog',
        sessionIdMissing: 'Session id was not found.',
        sessionNotFound: 'The requested session was not found.',
        sessionLoadFailed: 'Failed to load session data.',
        coverFallbackNote: 'English cover image pending',
      },
    };

    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('id');
    const initialLang = params.get('lang') || document.documentElement.lang || 'ja';
    const lang = normalizeLang(initialLang);

    const titleEl = document.getElementById('devlog-title');
    const metaEl = document.getElementById('devlog-meta');
    const coverEl = document.getElementById('devlog-cover');
    const coverNoteEl = document.getElementById('devlog-cover-note');
    const contentEl = document.getElementById('devlog-content');
    const errorEl = document.getElementById('devlog-error');
    const backLinkEl = document.querySelector('.back-link');

    document.documentElement.lang = lang;

    function normalizeLang(nextLang) {
      return SUPPORTED_LANGS.has(nextLang) ? nextLang : 'ja';
    }

    function t() {
      return UI[lang];
    }

    function pickLocalized(session, key) {
      const fallbackLang = lang === 'en' ? 'ja' : 'en';
      const byLangKey = `${key}_${lang}`;
      const fallbackByLangKey = `${key}_${fallbackLang}`;

      if (typeof session[byLangKey] === 'string' && session[byLangKey].trim()) return session[byLangKey];
      if (typeof session[fallbackByLangKey] === 'string' && session[fallbackByLangKey].trim()) return session[fallbackByLangKey];

      const value = session[key];
      if (typeof value === 'string' && value.trim()) return value;
      if (value && typeof value === 'object') {
        if (typeof value[lang] === 'string' && value[lang].trim()) return value[lang];
        if (typeof value[fallbackLang] === 'string' && value[fallbackLang].trim()) return value[fallbackLang];
      }
      return '';
    }

    function getSessionTitle(session) {
      return pickLocalized(session, 'title') || session.id;
    }

    function getSessionDateRange(session) {
      return pickLocalized(session, 'date_range') || session.id;
    }

    function resolveSessionCover(session) {
      if (lang === 'en') {
        const byLang = session.cover_by_lang;
        const explicitEn = (
          (typeof session.cover_en === 'string' && session.cover_en.trim() && session.cover_en)
          || (byLang && typeof byLang === 'object' && typeof byLang.en === 'string' && byLang.en.trim() && byLang.en)
          || ''
        );
        if (explicitEn) {
          return { src: explicitEn, localized: true };
        }
        return { src: DEVLOG_DEFAULT_COVER, localized: false };
      }

      const byLang = session.cover_by_lang;
      const jaCover = (
        (byLang && typeof byLang === 'object' && typeof byLang.ja === 'string' && byLang.ja.trim() && byLang.ja)
        || (typeof session.cover_ja === 'string' && session.cover_ja.trim() && session.cover_ja)
        || (typeof session.cover === 'string' && session.cover.trim() && session.cover)
        || ''
      );
      if (jaCover) return { src: jaCover, localized: true };
      return { src: DEVLOG_DEFAULT_COVER, localized: false };
    }

    function getSessionContentCandidates(session) {
      const fallbackLang = lang === 'en' ? 'ja' : 'en';
      const candidates = [];
      const contentByLang = session.content_by_lang;
      if (contentByLang && typeof contentByLang === 'object') {
        if (typeof contentByLang[lang] === 'string' && contentByLang[lang].trim()) {
          candidates.push(contentByLang[lang].trim());
        }
        if (typeof contentByLang[fallbackLang] === 'string' && contentByLang[fallbackLang].trim()) {
          candidates.push(contentByLang[fallbackLang].trim());
        }
      }
      if (lang === 'en') {
        candidates.push(`./content/devlog/${session.id}.en.md`);
      }
      candidates.push(`./content/devlog/${session.id}.md`);
      return [...new Set(candidates)];
    }

    async function loadSessionContent(session) {
      const paths = getSessionContentCandidates(session);
      for (const path of paths) {
        try {
          const res = await fetch(path);
          if (!res.ok) continue;
          const raw = await res.text();
          const content = raw.replace(/^---\n[\s\S]*?\n---\n*/m, '').trim();
          if (content) return content;
        } catch (error) {
          console.warn(`[devlog] Failed to load ${path}:`, error);
        }
      }
      return null;
    }

    function setupBackLink() {
      if (!backLinkEl) return;
      backLinkEl.textContent = t().backToIndex;
      backLinkEl.href = lang === 'en' ? 'index.html?lang=en' : 'index.html';
      backLinkEl.addEventListener('click', () => {
        try {
          sessionStorage.setItem(
            SCROLL_RESTORATION_ONCE_KEY,
            JSON.stringify({ armedAt: Date.now(), source: 'devlog-back-link' })
          );
          sessionStorage.setItem(
            DEVLOG_RETURN_INTENT_KEY,
            JSON.stringify({ requestedAt: Date.now(), sessionId })
          );
        } catch (e) {
          console.warn('[devlog] Failed to store return intent:', e);
        }
      });
    }

    function showError(message) {
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.remove('d-none');
      }
      if (contentEl) contentEl.innerHTML = '';
    }

    async function loadSession() {
      if (titleEl) titleEl.textContent = t().loading;
      setupBackLink();

      if (!sessionId) {
        showError(t().sessionIdMissing);
        if (titleEl) titleEl.textContent = t().devlogLabel;
        return;
      }

      try {
        const res = await fetch('./assets/devlog/sessions.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const sessions = await res.json();
        const session = sessions.find((item) => item.id === sessionId);

        if (!session) {
          showError(t().sessionNotFound);
          if (titleEl) titleEl.textContent = sessionId;
          return;
        }

        const sessionTitle = getSessionTitle(session);
        if (titleEl) titleEl.textContent = sessionTitle;
        if (metaEl) metaEl.textContent = getSessionDateRange(session);
        document.title = `${sessionTitle} - ${t().devlogLabel}`;

        const resolvedCover = resolveSessionCover(session);
        if (coverEl) {
          coverEl.src = resolvedCover.src;
          coverEl.classList.remove('d-none');
          coverEl.onerror = () => {
            coverEl.onerror = null;
            coverEl.src = DEVLOG_DEFAULT_COVER;
          };
          coverEl.addEventListener('click', () => {
            const lightboxImg = document.getElementById('lightbox-image');
            if (lightboxImg) {
              lightboxImg.src = coverEl.src;
              const lightboxModal = bootstrap.Modal.getOrCreateInstance(
                document.getElementById('imageLightboxModal')
              );
              lightboxModal.show();
            }
          });
        }
        if (coverNoteEl) {
          if (lang === 'en' && !resolvedCover.localized) {
            coverNoteEl.textContent = t().coverFallbackNote;
            coverNoteEl.classList.remove('d-none');
          } else {
            coverNoteEl.textContent = '';
            coverNoteEl.classList.add('d-none');
          }
        }

        const rawContent = await loadSessionContent(session);
        contentEl.innerHTML = rawContent ? DOMPurify.sanitize(marked.parse(rawContent)) : '';
      } catch (e) {
        console.warn('[devlog] Failed to load sessions.json:', e);
        showError(t().sessionLoadFailed);
      }
    }

    const lbImg = document.getElementById('lightbox-image');
    if (lbImg) {
      lbImg.addEventListener('click', () => {
        const m = bootstrap.Modal.getInstance(document.getElementById('imageLightboxModal'));
        if (m) m.hide();
      });
    }

    loadSession();
  </script>
</body>
</html>
